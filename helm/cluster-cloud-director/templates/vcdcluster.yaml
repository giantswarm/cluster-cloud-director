apiVersion: {{ include "infrastructureApiVersion" . }}
kind: VCDCluster
metadata:
  name: {{ include "resource.default.name" $ }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels.common" . | nindent 4 }}
spec:
  {{- with .Values.cloudDirector }}
  site: {{ .site }}
  org: {{ .org }}
  ovdc: {{ .ovdc }}
  ovdcNetwork: {{ .ovdcNetwork }}
  {{- end }}

  {{- with .Values.cluster }}
  # Picks an IP automatically if unset
  {{- if and .controlPlaneEndpoint.host .controlPlaneEndpoint.port }}
    controlPlaneEndpoint:
      host: {{ .controlPlaneEndpoint.host }}
      port: {{ .controlPlaneEndpoint.port }}
  {{- end }}

  # One arm is the old implementation with dnat rule + one arm LB
  loadBalancer:
    useOneArm: {{ .loadBalancer.useOneArm }}

  # Persistent storage with Named disks
  {{- with .defaultStorageClass }}
  {{- if .enable }}
  defaultStorageClassOptions:
    vcdStorageProfileName: {{ .vcdStorageProfileName }}
    k8sStorageClassName: {{ .k8sStorageClassName }}
    useDeleteReclaimPolicy: {{ .useDeleteReclaimPolicy }}
    fileSystem: {{ .fileSystem }}
  {{- end }}
  {{- end }}

  # Proxy settings
  proxyConfig:
    httpProxy: {{ .proxyConfig.httpProxy }}
    httpsProxy: {{ .proxyConfig.httpsProxy }}
    noProxy: {{ .proxyConfig.noProxy }}

  # Not tested - not sure how
  rdeId: {{ .rdeId }}
  parentUid: {{ .parentUid }}
  useAsManagementCluster: {{ .useAsManagementCluster }}
  {{- end }}

  # Authentication  
  userContext:
    {{- if .Values.userContext.secretRef.useSecretRef }}  # I don't trust the upstream prioritization.
    secretRef:
      name: {{ .Values.userContext.secretRef.secretName }}
      namespace: {{ .Release.Namespace }}
    {{- else }}
    refreshToken: {{ .Values.userContext.refreshToken }}
    username: {{ .Values.userContext.username }}
    password: {{ .Values.userContext.password }}
    {{- end }}
