apiVersion: {{ include "infrastructureApiVersion" . }}
kind: VCDCluster
metadata:
  name: {{ include "resource.default.name" $ }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels.common" . | nindent 4 }}
spec:
  {{- with .Values.cloudDirector }}
  site: {{ .site }}
  org: {{ .org }}
  ovdc: {{ .ovdc }}
  ovdcNetwork: {{ .ovdcNetwork }}
  {{- end }}

  {{- with .Values.network }}
  # Picks an IP automatically if unset
  {{- if and .controlPlaneEndpoint.host .controlPlaneEndpoint.port }}
  controlPlaneEndpoint:
    host: {{ .controlPlaneEndpoint.host }}
    port: {{ .controlPlaneEndpoint.port }}
  {{- end }}

  # One arm was the old implementation with dnat rule + one arm LB
  loadBalancer:
    vipSubnet: {{ .loadBalancer.vipSubnet }}
  {{- end }}

  # Proxy settings
  {{- if .Values.proxy.enabled }}
  proxyConfig:
    httpProxy: {{ .Values.proxy.httpProxy }}
    httpsProxy: {{ .Values.proxy.httpsProxy }}
    noProxy: {{ .Values.proxy.noProxy }}
  {{- end }}

  # Not tested - not sure how
  {{- with .Values.cluster }}
  rdeId: {{ .rdeId }}
  parentUid: {{ .parentUid }}
  useAsManagementCluster: {{ .useAsManagementCluster }}
  skipRDE: {{ .skipRDE }}
  {{- end }}

  # Authentication  
  userContext:
    {{- if .Values.userContext.secretRef.useSecretRef }}
    secretRef:
      name: {{ .Values.userContext.secretRef.secretName }}
      namespace: {{ .Release.Namespace }}
    {{- else }}
    refreshToken: {{ .Values.userContext.refreshToken }}
    username: {{ .Values.userContext.username }}
    password: {{ .Values.userContext.password }}
    {{- end }}
